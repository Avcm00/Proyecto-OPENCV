{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Estad√≠sticas{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-8 mb-8 text-white">
        <h1 class="text-4xl font-bold mb-2 flex items-center gap-3">
            <span>üìä</span> Mis Estad√≠sticas
        </h1>
        <p class="text-lg opacity-90">Resumen completo de tu actividad en la plataforma</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Columna Principal (2/3) -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Gr√°fico de An√°lisis por Mes -->
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span>üìà</span> An√°lisis por Mes
                </h2>
                
                {% if monthly_data %}
                <div class="relative h-80">
                    <canvas id="monthlyChart"></canvas>
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p>No hay suficientes datos para mostrar el gr√°fico</p>
                </div>
                {% endif %}
            </div>

            <!-- Distribuci√≥n de Formas Faciales -->
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span>üéØ</span> Distribuci√≥n de Formas Faciales
                </h2>
                
                {% if statistics.total_analyses > 0 %}
                <div class="space-y-4">
                    <!-- Aqu√≠ mostraremos las formas detectadas -->
                    <div class="p-6 border-2 border-indigo-200 rounded-xl bg-indigo-50">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-lg font-semibold text-indigo-900">{{ statistics.most_common_shape }}</span>
                            <span class="px-4 py-1 bg-indigo-600 text-white rounded-full text-sm font-bold">
                                M√°s Com√∫n
                            </span>
                        </div>
                        <p class="text-sm text-indigo-700">Esta es tu forma facial m√°s detectada</p>
                    </div>

                    <!-- Placeholder para otras formas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="text-sm text-gray-600">Oval</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="text-sm text-gray-600">Redondo</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="text-sm text-gray-600">Cuadrado</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl text-center">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="text-sm text-gray-600">Coraz√≥n</div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üéØ</div>
                    <p>Realiza m√°s an√°lisis para ver la distribuci√≥n</p>
                </div>
                {% endif %}
            </div>

            <!-- Evoluci√≥n del Feedback -->
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span>‚≠ê</span> Evoluci√≥n de tus Calificaciones
                </h2>
                
                {% if statistics.average_rating %}
                <div class="space-y-6">
                    <!-- Rating Promedio -->
                    <div class="text-center p-8 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl">
                        <div class="text-6xl font-bold text-yellow-600 mb-2">
                            {{ statistics.average_rating }}
                        </div>
                        <div class="text-2xl mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= statistics.average_rating %}
                                    <span class="text-yellow-400">‚òÖ</span>
                                {% else %}
                                    <span class="text-gray-300">‚òÖ</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-sm text-gray-600">Calificaci√≥n Promedio</p>
                    </div>

                    <!-- Desglose de Ratings -->
                    <div class="space-y-3">
                        {% for i in "54321" %}
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-medium text-gray-700 w-20">{{ i }} estrellas</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-3 rounded-full" 
                                     style="width: {% if forloop.counter == 1 %}60{% elif forloop.counter == 2 %}30{% else %}10{% endif %}%">
                                </div>
                            </div>
                            <span class="text-sm font-medium text-gray-600 w-12 text-right">
                                {% if forloop.counter == 1 %}60{% elif forloop.counter == 2 %}30{% else %}10{% endif %}%
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">‚≠ê</div>
                    <p>A√∫n no has calificado ning√∫n an√°lisis</p>
                    <a href="{% url 'feedback:history_list' %}" 
                       class="inline-block mt-4 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg transition">
                        Ver Historial
                    </a>
                </div>
                {% endif %}
            </div>

        </div>

        <!-- Sidebar (1/3) -->
        <div class="space-y-8">
            
            <!-- Resumen General -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span>üìã</span> Resumen General
                </h3>
                
                <div class="space-y-4">
                    <!-- Total de An√°lisis -->
                    <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs text-blue-600 font-medium mb-1">Total de An√°lisis</div>
                                <div class="text-3xl font-bold text-blue-700">{{ statistics.total_analyses }}</div>
                            </div>
                            <div class="text-4xl">üìä</div>
                        </div>
                    </div>

                    <!-- Forma M√°s Com√∫n -->
                    <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs text-purple-600 font-medium mb-1">Forma M√°s Com√∫n</div>
                                <div class="text-2xl font-bold text-purple-700">
                                    {{ statistics.most_common_shape|default:"‚Äî" }}
                                </div>
                            </div>
                            <div class="text-4xl">üéØ</div>
                        </div>
                    </div>

                    <!-- Rating Promedio -->
                    <div class="p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs text-yellow-600 font-medium mb-1">Rating Promedio</div>
                                <div class="text-3xl font-bold text-yellow-700">
                                    {% if statistics.average_rating %}
                                        {{ statistics.average_rating }} ‚≠ê
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-4xl">‚≠ê</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logros -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span>üèÜ</span> Logros
                </h3>
                
                <div class="space-y-4">
                    <!-- Logro 1 -->
                    {% if statistics.total_analyses >= 1 %}
                    <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200">
                        <div class="text-3xl">üéâ</div>
                        <div>
                            <div class="font-bold text-green-700">Primer An√°lisis</div>
                            <div class="text-xs text-green-600">Completaste tu primer an√°lisis</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl border-2 border-gray-200 opacity-50">
                        <div class="text-3xl">üîí</div>
                        <div>
                            <div class="font-bold text-gray-500">Primer An√°lisis</div>
                            <div class="text-xs text-gray-400">Realiza tu primer an√°lisis</div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Logro 2 -->
                    {% if statistics.total_analyses >= 5 %}
                    <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border-2 border-blue-200">
                        <div class="text-3xl">üöÄ</div>
                        <div>
                            <div class="font-bold text-blue-700">Explorador</div>
                            <div class="text-xs text-blue-600">5 an√°lisis completados</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl border-2 border-gray-200 opacity-50">
                        <div class="text-3xl">üîí</div>
                        <div>
                            <div class="font-bold text-gray-500">Explorador</div>
                            <div class="text-xs text-gray-400">Completa 5 an√°lisis</div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Logro 3 -->
                    {% if statistics.total_analyses >= 10 %}
                    <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                        <div class="text-3xl">üëë</div>
                        <div>
                            <div class="font-bold text-purple-700">Experto</div>
                            <div class="text-xs text-purple-600">10 an√°lisis completados</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl border-2 border-gray-200 opacity-50">
                        <div class="text-3xl">üîí</div>
                        <div>
                            <div class="font-bold text-gray-500">Experto</div>
                            <div class="text-xs text-gray-400">Completa 10 an√°lisis</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Acciones R√°pidas -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Acciones R√°pidas</h3>
                
                <div class="space-y-3">
                    <a href="/analysis/upload/"
                       class="block w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-center font-semibold rounded-lg px-6 py-3 shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300">
                        üîÑ Nuevo An√°lisis
                    </a>

                    <a href="{% url 'feedback:history_list' %}"
                       class="block w-full bg-white border-2 border-indigo-600 text-indigo-600 text-center font-semibold rounded-lg px-6 py-3 hover:bg-indigo-50 transition duration-300">
                        üìú Ver Historial
                    </a>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- Script para el gr√°fico -->
{% if monthly_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    
    const monthlyData = {{ monthly_data|safe }};
    const labels = Object.keys(monthlyData);
    const data = Object.values(monthlyData);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(label => {
                const [year, month] = label.split('-');
                const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${months[parseInt(month) - 1]} ${year}`;
            }),
            datasets: [{
                label: 'An√°lisis Realizados',
                data: data,
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: 'rgb(99, 102, 241)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgb(99, 102, 241)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        color: '#6B7280'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: '#6B7280'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});
</script>
{% endif %}

{% endblock %}